name: Build and deploy branch preview

on:
  push:
    branches:
      - "**"
  pull_request:
    branches:
      - "**"

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: branch-preview-${{ github.ref }}
  cancel-in-progress: true

jobs:
  preview:
    name: Build and publish preview
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Derive preview paths
        id: preview
        run: |
          ref_name="${GITHUB_HEAD_REF:-${GITHUB_REF_NAME}}"
          safe_ref=$(echo "$ref_name" | tr '/@ ' '---' | tr -cd '[:alnum:]._-')
          if [ -z "$safe_ref" ]; then
            safe_ref="preview"
          fi
          repo_name="${GITHUB_REPOSITORY#*/}"
          echo "ref_name=$ref_name" >> "$GITHUB_OUTPUT"
          echo "safe_ref=$safe_ref" >> "$GITHUB_OUTPUT"
          echo "repo_name=$repo_name" >> "$GITHUB_OUTPUT"
          echo "base_path=/$repo_name/previews/$safe_ref" >> "$GITHUB_OUTPUT"
          echo "publish_dir=previews/$safe_ref" >> "$GITHUB_OUTPUT"

      - name: Build static export
        env:
          NEXT_PUBLIC_BASE_PATH: ${{ steps.preview.outputs.base_path }}
        run: npm run build

      - name: Deploy preview to GitHub Pages
        if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./out
          destination_dir: ${{ steps.preview.outputs.publish_dir }}
          user_name: github-actions[bot]
          user_email: github-actions[bot]@users.noreply.github.com

      - name: Publish preview URL
        if: steps.preview.outputs.base_path && (github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository)
        run: |
          echo "Preview for ${GITHUB_REF_NAME} deployed to:" >> "$GITHUB_STEP_SUMMARY"
          echo "https://${GITHUB_REPOSITORY_OWNER}.github.io${{ steps.preview.outputs.base_path }}/" >> "$GITHUB_STEP_SUMMARY"
